name: Terraform Deployment

on:
push:
branches:
- 

jobs:
plan:
runs-on: ubuntu-latest

steps:
- name: Checkout repository
uses: actions/checkout@v2

- name: Setup Terraform
uses: hashicorp/setup-terraform@v1
with:
terraform_version: 0.15.0

- name: Terraform init
run: terraform init

- name: Terraform validate
run: terraform validate

- name: Terraform plan
run: terraform plan -out=tfplan

apply:
runs-on: ubuntu-latest
needs: plan

env:
AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
ARM_SUBSCRIPTION_ID: YOUR_SUBSCRIPTION_ID
ARM_TENANT_ID: YOUR_TENANT_ID

steps:
- name: Checkout repository
uses: actions/checkout@v2

- name: Setup Terraform
uses: hashicorp/setup-terraform@v1
with:
terraform_version: 0.15.0

- name: Login to Azure
run: |
az login --service-principal --username $AZURE_CLIENT_ID --password $AZURE_CLIENT_SECRET --tenant $ARM_TENANT_ID
az account set --subscription $ARM_SUBSCRIPTION_ID

- name: Terraform apply
run: terraform apply -auto-approve tfplan
